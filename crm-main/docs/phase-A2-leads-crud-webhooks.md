# Phase A2: Leads CRUD (Manual Entry)

## Context Links
- Parent: [plan.md](./plan.md)
- Depends on: [Phase A1](./phase-A1-lead-sources-backend.md)

## Parallelization Info
- **Group:** Track A
- **Can run with:** Phase B2, B3
- **Blocks:** Phase A3

## Overview
- **Priority:** P1
- **Status:** Pending
- **Owner:** Person A
- **Effort:** 20 minutes

Implement Leads CRUD endpoints for manual lead entry by admin.

## File Ownership (Exclusive)
- `server/routes/leads.ts`

## Implementation Steps

### 1. Leads CRUD (`server/routes/leads.ts`)

```typescript
import { Router } from 'express';
import { supabase } from '../lib/supabase';

const router = Router();

// GET /api/leads - with filters (US-03)
router.get('/', async (req, res) => {
  const { status, source_id, assigned_sales_id, limit = 50, offset = 0 } = req.query;

  let query = supabase
    .from('leads')
    .select(`
      *,
      lead_sources(name, type),
      campaigns(name),
      sales_employees(full_name, employee_code)
    `)
    .order('created_at', { ascending: false })
    .range(Number(offset), Number(offset) + Number(limit) - 1);

  // Status filter (US-03)
  if (status) {
    query = query.eq('status', status);
  }
  if (source_id) {
    query = query.eq('source_id', source_id);
  }
  if (assigned_sales_id) {
    query = query.eq('assigned_sales_id', assigned_sales_id);
  }

  const { data, error, count } = await query;
  if (error) return res.status(500).json({ error: error.message });
  res.json({ data, count });
});

// GET /api/leads/:id
router.get('/:id', async (req, res) => {
  const { data, error } = await supabase
    .from('leads')
    .select(`
      *,
      lead_sources(name, type),
      campaigns(name),
      sales_employees(full_name, employee_code)
    `)
    .eq('id', req.params.id)
    .single();

  if (error) return res.status(404).json({ error: 'Not found' });
  res.json(data);
});

// POST /api/leads - manual create
router.post('/', async (req, res) => {
  const { full_name, phone, email, demand, source_id, campaign_id, interested_product_group_id } = req.body;

  // source_label auto-generated by database trigger
  const { data, error } = await supabase
    .from('leads')
    .insert({
      full_name,
      phone,
      email,
      demand,
      source_id,
      campaign_id,
      interested_product_group_id,
      status: 'new'
    })
    .select()
    .single();

  if (error) return res.status(400).json({ error: error.message });

  // Auto-assign to sales (calls database function)
  if (data) {
    await supabase.rpc('auto_assign_lead', { p_lead_id: data.id });
  }

  res.status(201).json(data);
});

// PUT /api/leads/:id
router.put('/:id', async (req, res) => {
  const { status, demand, assigned_sales_id } = req.body;

  const updates: any = {};
  if (status) updates.status = status;
  if (demand) updates.demand = demand;
  if (assigned_sales_id) {
    updates.assigned_sales_id = assigned_sales_id;
    updates.assigned_at = new Date().toISOString();
    updates.assignment_method = 'manual';
  }

  const { data, error } = await supabase
    .from('leads')
    .update(updates)
    .eq('id', req.params.id)
    .select()
    .single();

  if (error) return res.status(400).json({ error: error.message });
  res.json(data);
});

// POST /api/leads/:id/convert - Convert to customer (US-07)
router.post('/:id/convert', async (req, res) => {
  const { data, error } = await supabase
    .rpc('convert_lead_to_customer', { p_lead_id: Number(req.params.id) });

  if (error) return res.status(400).json({ error: error.message });
  res.json({ customer_id: data });
});

// DELETE /api/leads/:id
router.delete('/:id', async (req, res) => {
  const { error } = await supabase
    .from('leads')
    .delete()
    .eq('id', req.params.id);

  if (error) return res.status(400).json({ error: error.message });
  res.status(204).send();
});

export default router;
```

## Todo List
- [ ] Create `server/routes/leads.ts` with full CRUD
- [ ] Test GET /api/leads with filters
- [ ] Test POST /api/leads creates and auto-assigns lead
- [ ] Test PUT /api/leads/:id updates status
- [ ] Test POST /api/leads/:id/convert converts to customer

## Success Criteria
- Leads can be manually created by admin (US-03)
- Leads filtered by status works (US-03)
- source_label auto-generated (US-02)
- Auto-assignment works on create
- Lead conversion to customer works

## Conflict Prevention
- Only Person A modifies these files
- Uses `auto_assign_lead` function (DB-level, no code conflict)
- No direct modification of sales_employees table

## Next Steps
â†’ Phase A3: Lead Frontend Updates
